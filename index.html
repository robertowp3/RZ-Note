<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RZ Note - Modern UI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* CSS Invariato */
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --bg-primary: #fdfdfd; --bg-secondary: #f4f4f5; --bg-tertiary: #e9e9ed; --bg-header: #2c3e50;
            --text-primary: #212529; --text-secondary: #5a5a5a; --border-color: #e0e0e0;
            --accent-primary: #3498db; --accent-primary-faded: #eaf5fc; --danger-primary: #e74c3c;
            --success-primary: #2ecc71; --shadow-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode {
            --bg-primary: #1e272e; --bg-secondary: #2c3a47; --bg-tertiary: #3b4c5a; --bg-header: #12181f;
            --text-primary: #f1f2f6; --text-secondary: #a4b0be; --border-color: #4a5a6a;
            --accent-primary-faded: #2c3a47; --shadow-color: rgba(0, 0, 0, 0.15);
        }
        body { font-family: var(--font-main); margin: 0; padding: 0; color: var(--text-primary); background-color: var(--bg-secondary); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        
        #app-header { display: flex; align-items: center; justify-content: space-between; height: 50px; background-color: black; color: white; padding: 0 20px; }
        #app-header h1 { margin: 0; font-size: 1.4em; letter-spacing: 1px; font-weight: 600; }
        #theme-toggle { background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; transition: background-color 0.2s; }
        #theme-toggle:hover { background-color: rgba(255, 255, 255, 0.1); }
        .fa-sun { display: none; }
        body.dark-mode .fa-moon { display: none; }
        body.dark-mode .fa-sun { display: inline-block; }
        #app-container { display: flex; height: calc(100vh - 50px); }
        
        #sidebar { width: 320px; min-width: 280px; background-color: #282828; border-right: 1px solid #444; display: flex; flex-direction: column; color: #f0f0f0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #444; }
        .sidebar-header h2 { margin: 0; font-size: 1.1em; cursor: pointer; font-weight: 600; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .add-icon { font-size: 1.2em; color: var(--accent-primary); transition: transform 0.3s ease, color 0.3s; }
        .sidebar-header h2:hover .add-icon { transform: scale(1.1) rotate(90deg); }
        #note-list { flex-grow: 1; overflow-y: auto; padding: 10px; list-style: none; }
        .subpage-list { list-style: none; padding-left: 20px; }
        
        .page {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 6px;
            position: relative;
            background-color: var(--page-color, var(--accent-primary));
            color: white;
            transition: filter 0.2s, box-shadow 0.2s;
        }
        
        #note-list li {
            margin-bottom: 4px;
        }

        .page:hover {
            filter: brightness(85%);
        }
        .page.active {
            font-weight: 600;
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.9);
            filter: brightness(100%);
        }
        
        .sortable-ghost {
            background-color: #454545 !important;
            opacity: 0.7;
            border: 2px dashed var(--accent-primary);
        }
        .sortable-ghost .page {
            visibility: hidden;
        }
        .sortable-drag {
            opacity: 0.9 !important;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .page .page-name { 
            flex-grow: 1; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            padding: 0 5px; 
            cursor: grab;
        }

        .collapse-toggle, .page-controls button {
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .collapse-toggle:hover, .page-controls button:hover {
            opacity: 1;
        }

        .collapse-toggle i,
        .page-controls button i {
            color: white;
        }

        .collapse-toggle.collapsed { transform: rotate(-90deg); }
        .collapse-placeholder { width: 20px; }
        .page-controls { display: flex; align-items: center; margin-left: auto; padding-left: 5px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .page:hover .page-controls, .page.active .page-controls { opacity: 1; }
        .page-controls button { background: none; border: none; cursor: pointer; font-size: 0.9em; padding: 4px; }
        
        .change-color-btn {
            width: 20px !important;
            height: 20px !important;
            padding: 0 !important;
            border-radius: 50% !important;
            border: 2px solid white !important;
            box-sizing: border-box !important;
        }
        
        .sidebar-footer { padding: 15px; border-top: 1px solid #444; display: flex; gap: 10px; }
        .sidebar-footer button, .import-label { flex: 1; padding: 10px; border: 1px solid #555; border-radius: 6px; background-color: #3a3a3a; color: white; cursor: pointer; text-align: center; font-weight: 500; transition: background-color 0.2s; }
        .sidebar-footer button:hover, .import-label:hover { background-color: #454545; }
        
        /* Stili rimanenti invariati... */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); }
        #page-view { display: flex; flex-direction: column; height: 100%; }
        #page-header { padding: 10px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #page-header h1 { margin: 0; font-size: 1.6em; font-weight: 700; }
        .page-header-controls { display: flex; align-items: center; gap: 15px; }
        .page-header-controls label { font-size: 0.9em; margin-right: 5px; color: var(--text-secondary); }
        .page-header-controls input[type="color"] { border: 1px solid var(--border-color); padding: 2px; border-radius: 4px; vertical-align: middle; }
        #copy-note-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); width: 36px; height: 36px; font-size: 1em; border-radius: 6px; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; }
        #copy-note-btn:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        #copy-note-btn.copied { background-color: var(--success-primary); color: white; border-color: var(--success-primary); }
        #editor-toolbar { padding: 8px 20px; border-bottom: 1px solid var(--border-color); background-color: var(--bg-secondary); }
        #editor-toolbar button, #format-block-select, #font-size-select { height: 36px; font-size: 0.9em; background-color: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; margin-right: 6px; vertical-align: middle; padding: 0 10px; transition: background-color 0.2s, border-color 0.2s; }
        #editor-toolbar button { padding: 0; width: 36px; }
        #editor-toolbar button:hover, #format-block-select:hover, #font-size-select:hover { background-color: var(--bg-tertiary); }
        #editor { flex-grow: 1; padding: 30px; font-size: 10px; font-weight: 400; line-height: 1.7; overflow-y: auto; outline: none; background-color: var(--page-background-color, var(--bg-primary)); transition: background-color 0.3s; }
        #editor:focus { box-shadow: inset 0 0 0 2px var(--accent-primary); }
        #editor a { color: var(--accent-primary); text-decoration: none; font-weight: 600; }
        #editor a:hover { text-decoration: underline; }
        #welcome-message { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: var(--text-secondary); }
        #welcome-message .fa-feather-alt { font-size: 4em; margin-bottom: 20px; }
        .hidden { display: none !important; }
        #create-note-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        #create-note-modal { background: var(--bg-primary); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 400px; }
        #create-note-modal h3 { margin-top: 0; font-size: 1.4em; }
        #new-note-name-input, #new-note-name-label { width: calc(100% - 20px); padding: 10px; font-size: 1em; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #new-note-name-label { border: none; background: none; padding: 0; margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary); }
        #color-swatch-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; position: relative; }
        .color-swatch.selected { border-color: var(--accent-primary); }
        .custom-color-swatch { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }
        .custom-color-swatch input[type="color"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        #confirm-create-note-btn { background: var(--accent-primary); color: white; }
        #cancel-create-note-btn { background: var(--bg-tertiary); color: var(--text-primary); }
    </style>
</head>
<body>
    <!-- HTML invariato -->
    <header id="app-header">
        <h1>RZ Note</h1>
        <button id="theme-toggle" title="Cambia tema"><i class="fas fa-moon"></i><i class="fas fa-sun"></i></button>
    </header>
    <div id="app-container">
        <aside id="sidebar">
            <div class="sidebar-header"><h2 id="add-note-trigger">Le tue Note <span class="add-icon">+</span></h2></div>
            <ul id="note-list"></ul>
            <div class="sidebar-footer"><button id="backup-btn"><i class="fas fa-download"></i> Backup</button><label for="import-input" class="import-label"><i class="fas fa-upload"></i> Importa</label><input type="file" id="import-input" accept=".json" style="display: none;"></div>
        </aside>
        <main id="main-content">
            <div id="page-view" class="hidden">
                <div id="page-header">
                    <h1 id="page-title-display"></h1>
                    <div class="page-header-controls">
                        <label>Sfondo:</label>
                        <input type="color" id="page-bg-color-picker" title="Colore di sfondo della nota">
                        <button id="copy-note-btn" title="Copia contenuto nota"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div id="editor-toolbar">
                    <select id="format-block-select"><option value="p">Testo Normale</option><option value="h1">Titolo 1</option><option value="h2">Titolo 2</option><option value="h3">Titolo 3</option></select>
                    <select id="font-size-select" title="Dimensione testo"><option value="10px">10px</option><option value="12px">12px</option><option value="14px">14px</option><option value="16px">16px</option><option value="18px">18px</option><option value="24px">24px</option></select>
                    <button data-command="bold" title="Grassetto"><i class="fas fa-bold"></i></button>
                    <button data-command="italic" title="Corsivo"><i class="fas fa-italic"></i></button>
                    <button data-command="underline" title="Sottolineato"><i class="fas fa-underline"></i></button>
                    <button data-command="insertOrderedList" title="Lista numerata"><i class="fas fa-list-ol"></i></button>
                    <button data-command="insertUnorderedList" title="Lista puntata"><i class="fas fa-list-ul"></i></button>
                    <button id="create-link-btn" title="Inserisci link"><i class="fas fa-link"></i></button>
                    <button id="insert-image-btn" title="Inserisci immagine da URL"><i class="fas fa-image"></i></button>
                </div>
                <div id="editor" contenteditable="true"></div>
            </div>
            <div id="welcome-message">
                <i class="fas fa-feather-alt"></i>
                <h1>Benvenuto in RZ Note!</h1>
                <p>Crea una nuova nota per iniziare.</p>
            </div>
        </main>
    </div>
    <div id="create-note-modal-overlay" class="hidden">
        <div id="create-note-modal">
            <h3>Crea Nuova Nota</h3>
            <p id="new-note-name-label" style="margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary);">Scegli un colore:</p>
            <input type="text" id="new-note-name-input" placeholder="Nome della nota...">
            <div id="color-swatch-container"></div>
            <div class="modal-actions">
                <button id="cancel-create-note-btn">Annulla</button>
                <button id="confirm-create-note-btn">Crea</button>
            </div>
        </div>
    </div>
    
    <!-- ======================= INIZIO BLOCCO SCRIPT MODIFICATO ======================= -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const applyTheme = (theme) => { theme === 'dark' ? body.classList.add('dark-mode') : body.classList.remove('dark-mode'); };
        const toggleTheme = () => { const currentTheme = body.classList.contains('dark-mode') ? 'light' : 'dark'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); };
        themeToggle.addEventListener('click', toggleTheme);
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) { applyTheme(savedTheme); } else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark ? 'dark' : 'light'); }

        let data = { notes: [] }; let currentPageId = null; let savedRange = null;
        const noteList = document.getElementById('note-list'); const editor = document.getElementById('editor'); const welcomeMessage = document.getElementById('welcome-message');
        const formatBlockSelect = document.getElementById('format-block-select'); const fontSizeSelect = document.getElementById('font-size-select');
        const modalOverlay = document.getElementById('create-note-modal-overlay');
        const modal = document.getElementById('create-note-modal');
        const modalInput = document.getElementById('new-note-name-input');
        const modalInputLabel = document.getElementById('new-note-name-label');
        const swatchContainer = document.getElementById('color-swatch-container');
        const confirmBtn = document.getElementById('confirm-create-note-btn');
        const cancelBtn = document.getElementById('cancel-create-note-btn');
        const copyNoteBtn = document.getElementById('copy-note-btn');
        const backupBtn = document.getElementById('backup-btn');
        // ===== NUOVA COSTANTE PER L'INPUT DI IMPORTAZIONE =====
        const importInput = document.getElementById('import-input'); 
        
        const PRESET_COLORS = [ '#d32f2f', '#c2185b', '#7b1fa2', '#512da8', '#303f9f', '#1976d2', '#0288d1', '#0097a7', '#00796b', '#388e3c', '#689f38', '#fbc02d', '#ffa000', '#f57c00', '#e64a19', '#6d4c41' ];
        let onConfirmCreateCallback = null;
        
        swatchContainer.addEventListener('click', (e) => {
            const clickedSwatch = e.target.closest('.color-swatch');
            if (clickedSwatch) {
                const currentSelected = swatchContainer.querySelector('.selected');
                if (currentSelected) {
                    currentSelected.classList.remove('selected');
                }
                clickedSwatch.classList.add('selected');
                const customInput = swatchContainer.querySelector('.custom-color-swatch input');
                if(customInput && clickedSwatch.dataset.color){
                    customInput.value = clickedSwatch.dataset.color;
                }
            }
        });

        const saveData = () => localStorage.setItem('webNoteData', JSON.stringify(data));
        const loadData = () => { const savedData = localStorage.getItem('webNoteData'); if (savedData) { data = JSON.parse(savedData); } else { data = { notes: [{ id: `page_${Date.now()}`, name: "Trascina per riordinare!", color: "#1976d2", backgroundColor: body.classList.contains('dark-mode') ? '#1e272e' : '#fdfdfd', content: `<h1>Drag and Drop!</h1><p>Ora puoi trascinare le note per riordinarle, o per annidarle una dentro l'altra.</p>`, subPages: [], isCollapsed: false }] }; } };
        
        const render = () => { 
            const scrollPos = noteList.scrollTop; 
            noteList.innerHTML = ''; 
            if (!data.notes || data.notes.length === 0) { 
                showWelcomeMessage(); 
            } else { 
                renderPagesRecursive(data.notes, noteList); 
            } 
            noteList.scrollTop = scrollPos; 
            initSortable(); 
            updateActivePageContent(); 
            saveData(); 
        };

        const renderPagesRecursive = (pages, parentElement) => {
            pages.forEach(page => {
                const hasSubPages = page.subPages && page.subPages.length > 0;
                page.isCollapsed = page.isCollapsed === undefined ? false : page.isCollapsed;
                const pageContainer = document.createElement('li');
                pageContainer.dataset.pageId = page.id;

                const pageEl = document.createElement('div');
                pageEl.className = 'page';
                pageEl.style.setProperty('--page-color', page.color);
                if (page.id === currentPageId) pageEl.classList.add('active');
                
                const collapseToggleHTML = hasSubPages ? `<span class="collapse-toggle ${page.isCollapsed ? 'collapsed' : ''}"><i class="fas fa-chevron-down"></i></span>` : `<span class="collapse-placeholder"></span>`;
                pageEl.innerHTML = `${collapseToggleHTML}<span class="page-name">${page.name}</span><div class="page-controls"><button class="rename-btn" title="Rinomina"><i class="fas fa-pencil-alt"></i></button><button class="add-sibling-btn" title="Aggiungi nota qui"><i class="fas fa-plus-circle"></i></button><button class="add-subpage-btn" title="Aggiungi sotto-nota"><i class="fas fa-sitemap"></i></button><button class="change-color-btn" style="background-color: ${page.color};" title="Cambia colore"></button><button class="delete-btn delete-page-btn" title="Cancella"><i class="fas fa-trash"></i></button></div>`;
                
                pageContainer.appendChild(pageEl);
                if (hasSubPages && !page.isCollapsed) {
                    const subPageListEl = document.createElement('ul');
                    subPageListEl.className = 'subpage-list';
                    pageContainer.appendChild(subPageListEl);
                    renderPagesRecursive(page.subPages, subPageListEl);
                }
                parentElement.appendChild(pageContainer);
            });
        };

        const updateActivePageContent = () => { const pageView = document.getElementById('page-view'); const pageTitleDisplay = document.getElementById('page-title-display'); const pageBgColorPicker = document.getElementById('page-bg-color-picker'); if (currentPageId) { const { page } = findPage(currentPageId); if (page) { welcomeMessage.classList.add('hidden'); pageView.classList.remove('hidden'); pageTitleDisplay.textContent = page.name; editor.innerHTML = page.content; const defaultBg = body.classList.contains('dark-mode') ? '#1e272e' : '#fdfdfd'; const bgColor = page.backgroundColor || defaultBg; pageBgColorPicker.value = bgColor; editor.style.setProperty('--page-background-color', bgColor); } else { currentPageId = null; showWelcomeMessage(); } } else showWelcomeMessage(); };
        const showWelcomeMessage = () => { document.getElementById('page-view').classList.add('hidden'); welcomeMessage.classList.remove('hidden'); };
        const findPage = (pageId, pages = data.notes) => { for (const page of pages) { if (page.id === pageId) return { page, parentList: pages }; if (page.subPages) { const found = findPage(pageId, page.subPages); if (found.page) return found; } } return { page: null, parentList: null }; };
        
        const initSortable = () => {
            document.querySelectorAll('#note-list, .subpage-list').forEach(list => {
                if (list.sortable) list.sortable.destroy(); // Distruggi l'istanza precedente se esiste
                list.sortable = new Sortable(list, {
                    group: 'nested-notes',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    handle: '.page-name', 
                    onEnd: handleDropEvent,
                });
            });
        };

        const handleDropEvent = (evt) => {
            const draggedItemId = evt.item.dataset.pageId;
            const { page: draggedPage, parentList: fromList } = findPage(draggedItemId);

            if (!draggedPage) return;

            fromList.splice(fromList.indexOf(draggedPage), 1);

            const targetListEl = evt.to;
            let toList;

            if (targetListEl.id === 'note-list') {
                toList = data.notes;
            } else {
                const parentItemId = targetListEl.closest('li').dataset.pageId;
                const { page: newParentPage } = findPage(parentItemId);
                if (!newParentPage) return; 
                if (!newParentPage.subPages) {
                    newParentPage.subPages = [];
                }
                toList = newParentPage.subPages;
            }

            toList.splice(evt.newIndex, 0, draggedPage);
            render();
        };

        const applyFontSize = (size) => { if (!savedRange) { return; } editor.focus(); const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(savedRange); const uniqueId = `temp-font-size-${Date.now()}`; document.execCommand('fontName', false, uniqueId); const fontElements = editor.querySelectorAll(`font[face="${uniqueId}"]`); fontElements.forEach(fontElement => { const span = document.createElement('span'); span.style.fontSize = size; while(fontElement.firstChild) { span.appendChild(fontElement.firstChild); } fontElement.parentNode.replaceChild(span, fontElement); }); };
        const saveSelection = () => { const selection = window.getSelection(); if (selection.rangeCount > 0) { const range = selection.getRangeAt(0); if (editor.contains(range.commonAncestorContainer)) { savedRange = range.cloneRange(); } } };
        editor.addEventListener('mouseup', saveSelection); editor.addEventListener('keyup', saveSelection); editor.addEventListener('focus', saveSelection); document.addEventListener('selectionchange', saveSelection);
        
        const showCreateNoteModal = (callback, options = {}) => { const config = { title: 'Crea Nuova Nota', confirmText: 'Crea', showNameInput: true, defaultColor: PRESET_COLORS[0], ...options }; onConfirmCreateCallback = callback; modal.querySelector('h3').textContent = config.title; confirmBtn.textContent = config.confirmText; modalInput.style.display = config.showNameInput ? 'block' : 'none'; modalInputLabel.style.display = config.showNameInput ? 'block' : 'none'; if(config.showNameInput){ modalInputLabel.textContent = "Nome della nota:"; modalInput.value = ''; } else { modalInputLabel.textContent = "Scegli un colore:"; } swatchContainer.innerHTML = ''; const isPreset = PRESET_COLORS.includes(config.defaultColor); PRESET_COLORS.forEach(color => {  const swatch = document.createElement('div');  swatch.className = 'color-swatch';  swatch.style.backgroundColor = color;  swatch.dataset.color = color;  if (color === config.defaultColor) swatch.classList.add('selected');  swatchContainer.appendChild(swatch);  }); const customSwatch = document.createElement('div');  customSwatch.className = 'color-swatch custom-color-swatch';  if (!isPreset) customSwatch.classList.add('selected'); const customInput = document.createElement('input');  customInput.type = 'color';  customInput.value = config.defaultColor;  customSwatch.appendChild(customInput);  swatchContainer.appendChild(customInput); modalOverlay.classList.remove('hidden');  if(config.showNameInput) modalInput.focus(); };
        const hideCreateNoteModal = () => { modalOverlay.classList.add('hidden'); onConfirmCreateCallback = null; };
        
        document.getElementById('add-note-trigger').addEventListener('click', () => { showCreateNoteModal((name, color) => { const newPage = { id: `page_${Date.now()}`, name, color, backgroundColor: body.classList.contains('dark-mode') ? '#1e272e' : '#fdfdfd', content: `<h1>${name}</h1>`, subPages: [], isCollapsed: false }; data.notes.push(newPage); currentPageId = newPage.id; render(); }); });
        
        noteList.addEventListener('click', e => {
            const pageEl = e.target.closest('.page'); 
            if (!pageEl) return;
            const pageId = pageEl.closest('li').dataset.pageId;
            if (!pageId) return;

            if (e.target.closest('.change-color-btn')) { e.stopPropagation(); const { page } = findPage(pageId); if (page) { showCreateNoteModal( (color) => { page.color = color; render(); }, { title: 'Cambia Colore Nota', confirmText: 'Salva', showNameInput: false, defaultColor: page.color } ); } }
            else if (e.target.closest('.collapse-toggle')) { const { page } = findPage(pageId); if (page) { page.isCollapsed = !page.isCollapsed; render(); } }
            else if (e.target.closest('.rename-btn')) { /* ... */ }
            else if (e.target.closest('.add-sibling-btn')) { const { page: sourcePage, parentList } = findPage(pageId); if (sourcePage && parentList) { showCreateNoteModal((name, color) => { const newPage = { id: `page_${Date.now()}`, name, color, backgroundColor: body.classList.contains('dark-mode') ? '#1e272e' : '#fdfdfd', content: `<h1>${name}</h1>`, subPages: [], isCollapsed: false }; const currentIndex = parentList.findIndex(p => p.id === pageId); parentList.splice(currentIndex + 1, 0, newPage); currentPageId = newPage.id; render(); }, { defaultColor: sourcePage.color }); } }
            else if (e.target.closest('.add-subpage-btn')) { const { page: parentPage } = findPage(pageId); if (parentPage) { showCreateNoteModal((name, color) => { if (!parentPage.subPages) parentPage.subPages = []; const newSubPage = { id: `page_${Date.now()}`, name, color, backgroundColor: body.classList.contains('dark-mode') ? '#1e272e' : '#fdfdfd', content: `<h1>${name}</h1>`, subPages: [], isCollapsed: false }; parentPage.subPages.push(newSubPage); if (parentPage.isCollapsed) parentPage.isCollapsed = false; currentPageId = newSubPage.id; render(); }, { defaultColor: parentPage.color }); } }
            else if (e.target.closest('.delete-page-btn')) { const { page, parentList } = findPage(pageId); if (page && parentList && confirm(`Cancellare "${page.name}"?`)) { parentList.splice(parentList.findIndex(p => p.id === page.id), 1); if (currentPageId === page.id) currentPageId = null; render(); } }
            else { currentPageId = pageId; render(); }
        });
        
        backupBtn.addEventListener('click', () => {
            if (!data || !data.notes || data.notes.length === 0) {
                alert("Non ci sono note da salvare nel backup.");
                return;
            }
            try {
                const backupData = JSON.stringify(data, null, 2);
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.download = `rz-note-backup-${date}.json`;
                a.href = url;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Errore durante la creazione del backup:", error);
                alert("Si è verificato un errore durante la creazione del backup.");
            }
        });

        // ===== INIZIO CODICE AGGIUNTO PER L'IMPORTAZIONE =====
        importInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return; // Nessun file selezionato
            }

            if (!confirm("Sei sicuro di voler importare questo backup? Le note attuali verranno sovrascritte.")) {
                event.target.value = null; // Resetta l'input se l'utente annulla
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validazione di base del file di backup
                    if (backupData && Array.isArray(backupData.notes)) {
                        data = backupData;
                        currentPageId = null; // Deseleziona la pagina attiva
                        render(); // Ri-renderizza l'intera UI con i nuovi dati
                        alert('Backup ripristinato con successo!');
                    } else {
                        throw new Error("Formato del file di backup non valido.");
                    }
                } catch (error) {
                    console.error("Errore durante il ripristino del backup:", error);
                    alert("Errore: il file di backup non è valido o è corrotto.");
                } finally {
                    // Resetta il valore dell'input per permettere di ricaricare lo stesso file
                    event.target.value = null;
                }
            };

            reader.onerror = () => {
                alert("Impossibile leggere il file selezionato.");
                event.target.value = null;
            };

            reader.readAsText(file);
        });
        // ===== FINE CODICE AGGIUNTO PER L'IMPORTAZIONE =====


        confirmBtn.addEventListener('click', () => {  const selectedSwatch = swatchContainer.querySelector('.selected');  if (!selectedSwatch || !onConfirmCreateCallback) { hideCreateNoteModal(); return; } const color = selectedSwatch.dataset.color || selectedSwatch.querySelector('input[type="color"]').value; if (modalInput.style.display !== 'none') { const name = modalInput.value.trim(); if (name) { onConfirmCreateCallback(name, color); } } else { onConfirmCreateCallback(color); } hideCreateNoteModal();  });
        
        copyNoteBtn.addEventListener('click', () => { if (!currentPageId) return; const textToCopy = editor.innerText; navigator.clipboard.writeText(textToCopy).then(() => { const originalTitle = copyNoteBtn.title; const originalIcon = copyNoteBtn.innerHTML; copyNoteBtn.title = 'Copiato!'; copyNoteBtn.innerHTML = `<i class="fas fa-check"></i>`; copyNoteBtn.classList.add('copied'); setTimeout(() => { copyNoteBtn.title = originalTitle; copyNoteBtn.innerHTML = originalIcon; copyNoteBtn.classList.remove('copied'); }, 2000); }).catch(err => { console.error('Errore copia:', err); alert('Impossibile copiare.'); }); });
        cancelBtn.addEventListener('click', hideCreateNoteModal); modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideCreateNoteModal(); });
        
        fontSizeSelect.addEventListener('change', () => applyFontSize(fontSizeSelect.value));
        
        document.getElementById('editor-toolbar').addEventListener('click', e => { const button = e.target.closest('button[data-command]'); if (button) { document.execCommand(button.dataset.command, false, null); editor.focus(); }});
        
        editor.addEventListener('input', () => { if(currentPageId){const{page}=findPage(currentPageId);if(page)page.content=editor.innerHTML;saveData();}});
        document.getElementById('page-bg-color-picker').addEventListener('input', e => { if(currentPageId){const{page}=findPage(currentPageId);if(page){page.backgroundColor=e.target.value;editor.style.setProperty('--page-background-color', e.target.value);saveData();}}});
        document.getElementById('create-link-btn').addEventListener('click', () => { const u = prompt("URL:", "https://"); if(u)document.execCommand('createLink',false,u); editor.focus();});
        
        loadData();
        render();
    });
    </script>
    <!-- ======================= FINE BLOCCO SCRIPT MODIFICATO ======================= -->
</body>
</html>
